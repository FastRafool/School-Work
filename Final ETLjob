import boto3
import pandas as pd
import re
from io import StringIO

s3 = boto3.client('s3')
bucket = 'project4444'
key = 'results/results.txt'

def read_from_s3():
    obj = s3.get_object(Bucket=bucket, Key=key)
    return obj['Body'].read().decode('utf-8')

def write_to_s3(output_key, df):
    csv_buffer = StringIO()
    df.to_csv(csv_buffer, index=False)
    s3.put_object(Bucket=bucket, Key=output_key, Body=csv_buffer.getvalue())

data = read_from_s3()

# Splitting data by meal plans
meal_plans_data = data.split('Meal plan')[1:]

summary_records = []
details_records = []

for meal_plan_number, meal_plan_data in enumerate(meal_plans_data, start=1):
    meal_plan_lines = meal_plan_data.strip().split('\n')
    
    # Summary record
    summary_record = {'Meal Plan': meal_plan_number}
    for line in meal_plan_lines[-6:]:
        key, value = line.split(':')
        summary_record[key.strip()] = value.strip()
    summary_records.append(summary_record)

    # Details records
    for line in meal_plan_lines[:-6]:
        if re.match(r'^[A-Z0-9]+\s+x\d', line): # Match lines containing ASIN and quantity
            parts = line.split(' / ')
            asin_quantity = parts[0].split(' x')
            asin = asin_quantity[0].strip()
            quantity = asin_quantity[1].strip()
            daily_servings = parts[1].split(':')[-1].strip()
            category = parts[2].strip()
            details_records.append([meal_plan_number, asin, quantity, daily_servings, category])

df_summary = pd.DataFrame(summary_records)
summary_output_key = 'meal_plan_summary.csv'
write_to_s3(summary_output_key, df_summary)

df_details = pd.DataFrame(details_records, columns=['Meal Plan', 'ASIN', 'Quantity', 'Daily Servings', 'Category'])
details_output_key = 'meal_plan_details.csv'
write_to_s3(details_output_key, df_details)
