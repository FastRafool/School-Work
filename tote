import boto3
import pandas as pd
import csv
from io import StringIO

s3 = boto3.client('s3')
bucket = 'project4444'

# Function to read data from S3
def read_from_s3(key):
    obj = s3.get_object(Bucket=bucket, Key=key)
    return obj['Body'].read().decode('utf-8')

# Function to write DataFrame to S3
def write_dataframe_to_s3(key, df):
    csv_buffer = StringIO()
    df.to_csv(csv_buffer, index=False)
    s3.put_object(Bucket=bucket, Key=key, Body=csv_buffer.getvalue())

# Function to write CSV data to S3
def write_csv_to_s3(key, data):
    s3.put_object(Bucket=bucket, Key=key, Body=data)

# Read and process meal plan summary data
summary_key = 'results.txt'
data = read_from_s3(summary_key)

data = data.split('\n')
meal_plans = []
meal_plan_number = 1
for line in data:
    if line.startswith('Meal plan'):
        meal_plan = {'Meal Plan': meal_plan_number}
        meal_plan_number += 1
    elif line.startswith('Average') or line.startswith('Total'):
        key, value = line.split(':')
        meal_plan[key] = value.strip()
    elif line == '':
        meal_plans.append(meal_plan)
df_summary = pd.DataFrame(meal_plans)

# Write meal plan summary to S3
summary_output_key = 'destination2-key.csv'
write_dataframe_to_s3(summary_output_key, df_summary)

# Read and process meal plan details data
details_key = 'meal_plan_details.txt'
data = read_from_s3(details_key)

meal_plan_number = None
rows = []
for line in data.split('\n'):
    if line.startswith('Meal plan'):
        meal_plan_number = line.split(' ')[-1].strip(':')
    elif line.startswith('B'):
        asin, quantity, daily_servings, category = line.split(' / ')
        quantity = quantity.split('x')[-1].strip()
        daily_servings = daily_servings.split(':')[-1].strip()
        rows.append([meal_plan_number, asin, quantity, daily_servings, category])

# Write meal plan details to CSV and upload to S3
csv_output = StringIO()
csv_writer = csv.writer(csv_output)
csv_writer.writerow(['Meal Plan', 'ASIN', 'Quantity', 'Daily Servings', 'Category'])
csv_writer.writerows(rows)
details_output_key = 'meal_plan_details.csv'
write_csv_to_s3(details_output_key, csv_output.getvalue())
